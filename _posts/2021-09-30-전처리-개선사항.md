---
title:  "[OCR Project] 전처리 수행 및 OCR 영역 추출"
excerpt: "이미지 전처리 및 OCR 모델 훈련 프로젝트 수행일지입니다."

toc: False
toc_sticky: False
toc_label: "주요 목차"

date: 2021-09-30
last_modified_at: 2021-09-30

use_math: true
comments: true

categories:
  - OCR Project
---

## 📌 [개선사항]('/210929 OCR 수행일지')

- 1. 이미지를 줄이지 않고 좌표에 원래 비율을 적용할 것
- 2. 기울어진 이미지는 이미지 투시변환 및 회전 필요함
- 위 사항을 개선해보면서 새로 발생한 이슈와 해결방법을 기록함



### 1. ROI 좌표를 원래 이미지 비율로 변환 ✔

- **좌표변환**
  - ROI 좌표은 이미지 가로길이 700px 기준으로 작성되었으므로 원본 이미지 사이즈에 대응되는 좌표 변환이 필요함
  - (참고링크) [Transformations between Coordinates ](https://stackoverflow.com/questions/29924150/numpy-transformations-between-coordinate-systems)
- 이미지에서 좌표에 대한 이해
  - OpenCV에서 좌표는 이미지의 왼쪽 상단을 기준점(0, 0)으로 둠


### 2. 이미지 사이즈 변환 후 전처리 파라미터 조절 ✔

- **kernel size**

  - 모폴로지 연산 수행 중 이미지 사이즈에 비해 커널 사이즈가 상대적으로 작아져서 전과 같은 효과를 낼 수 없음
  - kernel size가 이미지 사이즈별로 적절히 설정되도록 조정함

### 3. 기울어진 이미지 투시변환 ✔
- tesseract는 회전 및 기울어진 이미지를 읽어내지 못함




## 📌 새로운 이슈와 해결방안

### contouring 영역이 사각형에서 크게 벗어난 형태인 경우가 많음

- 근사화를 수행해도 사각형이 되지 않는 경우 데이터 영역을 추출할 수 없음
- 방법1. 모폴로지 연산으로 더 큰 덩어리가 지도록 시도함 ✔
- 방법2. 사각형이 아닌 다각형도 일단 가져옴 (일단 보류)


### 텍스트 중 "교류 3상" 부분이 왼쪽 그림자와 한 덩어리로 묶여서 contouring 시 사각형으로 추출되지 않음
- 방법1. 이진화를 통해 그림자와 텍스트가 별개로 인식되도록 처리함 ✔ (효과는 미미했음)
- 방법2. contouring을 더 섬세하게 함 ✔
	- 📍문제 : 교류3상은 잡히는데 Gtype 부분이 안 잡힘
- 방법3. 다각형에서 사각형을 추출할 때 더 러프하게 가져오도록 함 ✔
	- 외곽선을 근사화 할 때 epsilon값을 조절함
	- approx = cv2.approxPolyDP(con, epsilon * perimeter, True)
	- epsilon 은 original curve와 근사치의 최대거리
	- 최대거리가 클 수록 더 먼 곳의 Point까지 고려하기 때문에 Point수가 줄어듬



## 📌 결론

- 원본이미지에 대해 전처리 수행함
	- 기존에는 이미지의 사이즈를 가로길이 700px로 축소하여 처리하였으나
	  텍스트 영역은 전체 이미지에서 매우 작으므로 이미지를 축소하면 텍스트가 깨졌음
	
- 전처리 과정을 개선함
```
이진화 >> 침식(cv2.MORPH_ELLIPSE) >> 팽창 (cv2.MORPH_RECT) >> 침식(cv2.MORPH_RECT) >> Contouring >> 다각형 근사화 >> 사각형 박스 추출 >> 이미지 슬라이싱 >> 저장
```

- 특히 모폴로지 연산 과정을 수정함
	- OpenCV가 지원하는 gradient, close 메소드를 이용하면 침식, 팽창의 방식(커널 모양, 사이즈)이 동일하게 설정됨
	- 직접 침식과 팽창의 커널 모양, 커널 사이즈를 설정하고 반복 수행하여 계량기 이미지에 적절한 전처리 방식을 찾음

- 외곽선 근사화 시, epsilon값의 상승폭을 0.001로 줌
```python
 for epsilon in range(0, 200):
                    epsilon = epsilon/1000              # epsilon 을 0.001 단위로 늘려가며 적용해야 "G-Type"부분이 잡힘
                    approx = cv2.approxPolyDP(con, epsilon * perimeter, True)
```




## 📌앞으로 수행할 것

1. 위의 전처리를 수행하여 추출한 각 데이터 이미지에 대해 OCR을 수행할 예정임

2. 투시변환 수행할 예정임

  - 각각의 계량기 이미지에서 추출한 데이터 이미지 중 
    세로 길이가 원본 이미지의 1/3 이상 되는 경우, 배경이 제거된 계량기 영역일 가능성이 높음
  - 계량기 영역을 투시변환에 이용하는 방식 고려함
  - 별도 저장시 해당 이미지 폴더명 + 인덱스로 이름을 이용하면 특정 가능함

  



